version: 0.2

phases:
  install:
    commands:
      - apt-get update
      - apt-get install -y nfs-common
  pre_build:
    commands:
      - mkdir /efs
      - mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2 fs-9551addd.efs.us-east-1.amazonaws.com:/ /efs
      #- pkill -f dockerd
      #- rm -rf /var/run/docker.pid
      #- /bin/sh $CODEBUILD_SRC_DIR/dockerd-entrypoint.sh while [ ! -f /codebuild/readonly/bin/executor.done ]; do sleep 1; done && /codebuild/readonly/bin/executor
  build:
    commands:
      - ps aux | grep docker
      - docker build -t testimage:v.0.0.1 .
  post_build:
    commands:
      - echo Check if docker storage is on EFS...
      - ls -al /efs